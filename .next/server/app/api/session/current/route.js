"use strict";(()=>{var e={};e.id=340,e.ids=[340],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},2250:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>N,patchFetch:()=>S,requestAsyncStorage:()=>E,routeModule:()=>m,serverHooks:()=>O,staticGenerationAsyncStorage:()=>w});var i={};s.r(i),s.d(i,{GET:()=>g,POST:()=>_,dynamic:()=>c});var r=s(9303),n=s(8716),a=s(670),o=s(7070),u=s(5324),l=s(8547),p=s(6543);let c="force-dynamic",d=p.Ryn({action:p.KmV(["RESUME","RESTORE","PAUSE","ABORT","FINALIZE_FAILURE","WIPE"])});async function g(){let e=await (0,u.zA)();return o.NextResponse.json(e.currentSession)}async function _(e){try{let t=await e.json(),s=d.safeParse(t);if(!s.success)return o.NextResponse.json({error:"Invalid action payload",details:s.error.errors},{status:400});let{action:i}=s.data;if("RESUME"===i){let e=await (0,u.CT)(e=>{if("LOCKED"===e.status)throw Error("Session is LOCKED. Use RESTORE.");return{...e,status:"RUNNING"}});return o.NextResponse.json(e)}if("RESTORE"===i){let e=await (0,u.CT)(e=>{if("LOCKED"!==e.status)return e;let t=[...e.violations];return t.length>=2&&t.pop(),{...e,status:"RUNNING",violations:t,warningTriggered:t.length>0}});return o.NextResponse.json(e)}if("PAUSE"===i){let e=await (0,u.CT)(e=>({...e,status:"HOLD"}));return o.NextResponse.json(e)}if("ABORT"===i){let e=await (0,u.CT)(e=>{let t={id:(0,l.Z)(),type:"ABANDONED",timestamp:new Date().toISOString()};return{...e,status:"LOCKED",violations:[...e.violations,t]}});return o.NextResponse.json(e)}if("FINALIZE_FAILURE"===i){let e=await (0,u.CT)(e=>({...e,status:"LOCKED"}));return o.NextResponse.json(e)}if("WIPE"===i){if((await (0,u.zA)()).currentSession)return await (0,u.CT)(e=>({...e,status:"ABANDONED"})),o.NextResponse.json({status:"WIPED"});return o.NextResponse.json({status:"NO_SESSION"})}return o.NextResponse.json({error:"Invalid action"},{status:400})}catch(e){return o.NextResponse.json({error:e.message},{status:400})}}let m=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/session/current/route",pathname:"/api/session/current",filename:"route",bundlePath:"app/api/session/current/route"},resolvedPagePath:"/app/src/app/api/session/current/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:E,staticGenerationAsyncStorage:w,serverHooks:O}=m,N="/api/session/current/route";function S(){return(0,a.patchFetch)({serverHooks:O,staticGenerationAsyncStorage:w})}},1926:(e,t,s)=>{s.d(t,{O:()=>a});var i=s(7857);let r=process.env.SUPABASE_URL||"",n=process.env.SUPABASE_SERVICE_ROLE_KEY||"";r&&n||console.warn("Supabase keys missing. DB calls will fail.");let a=(0,i.eI)(r,n)},5324:(e,t,s)=>{s.d(t,{CT:()=>u,oY:()=>a,zA:()=>o});var i=s(1926),r=s(1615),n=s(8547);function a(){let e=(0,r.cookies)(),t=e.get("uid")?.value;if(!t)throw Error("Security Violation: No User Identity found in request context.");return t}async function o(){let e=a(),{data:t}=await i.O.from("users").select("*").eq("id",e).single();if(!t){let{data:s}=await i.O.from("users").insert({id:e,identity_hash:"ANON_V1",is_demo:0,uptime_seconds:0}).select().single();t=s}let{data:s}=await i.O.from("sessions").select(`
    *,
    violations(*),
    range_objectives(*)
        `).eq("user_id",e).neq("status","COMPLETED").neq("status","ABANDONED").order("start_time",{ascending:!1}).limit(1).single(),r=null;return s&&(r={date:s.started_at_iso?s.started_at_iso.split("T")[0]:new Date().toISOString().split("T")[0],mainTitle:s.main_title||"Session",progressPercent:s.progress_percent,status:s.status,violations:(s.violations||[]).map(e=>({id:e.id,type:e.type,timestamp:e.timestamp_iso})),warningTriggered:!!s.warning_triggered,queue:(s.range_objectives||[]).map(e=>({id:e.id,title:e.title,timeBlock:e.time_block,intensity:e.intensity,status:e.status,progress:e.progress})),startTime:s.started_at_iso,durationMinutes:s.duration_minutes}),{userState:{identity:t?.identity_hash||"UNKNOWN",uptime:t?.uptime_seconds||0,securityProtocol:t?.security_protocol||"AES-256",specificityLevel:t?.specificity_level||4},tracks:[{id:"SYL_MOD_06_UPLINK",name:"Module_06: Technical_Console",riskLevel:"MEDIUM",status:"ACTIVE",objectives:[]}],currentSession:r}}async function u(e){let t=(await o()).currentSession;t||(t={date:new Date().toISOString().split("T")[0],mainTitle:"New Session",progressPercent:0,status:"HOLD",violations:[],warningTriggered:!1,queue:[]});let s=e(t),{data:r}=await i.O.from("sessions").select("id").eq("user_id",a()).neq("status","COMPLETED").neq("status","ABANDONED").limit(1).single(),u=r?.id||(0,n.Z)();r||await i.O.from("sessions").insert({id:u,user_id:a(),status:s.status,start_time:Math.floor(Date.now()/1e3),main_title:s.mainTitle,progress_percent:s.progressPercent,warning_triggered:s.warningTriggered?1:0,started_at_iso:s.startTime||new Date().toISOString(),duration_minutes:s.durationMinutes});let{error:l}=await i.O.rpc("update_session_with_violations",{p_session_id:u,p_status:s.status,p_progress:s.progressPercent,p_warning:s.warningTriggered,p_violations:s.violations,p_main_title:s.mainTitle});if(l)throw console.error("RPC Update Failed:",l),Error("Failed to persist session state safely.");return s}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),i=t.X(0,[948,6,972,543],()=>s(2250));module.exports=i})();